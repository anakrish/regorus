\<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Regorus Playground</title>
    <link
      rel="stylesheet"
      data-name="vs/editor/editor.main"
      href="./node_modules/monaco-editor/min/vs/editor/editor.main.css"
      />
  </head>
  <body>
    <h2>Regorus Playground</h2>

    <div id="leftPane">
      <div class="paneheader">
	Policy
      </div>
      <div id="rego_container" style="height:600px; width: 400px; border: 1px solid grey; float: left"></div>
      <div id="langPane"></div>
    </div>

    <div style="width:400px; height:600px; float:left"></div>

    <div id="rightPane">
      <div class="paneheader">
	Input JSON
      </div>
      <div id="input_container" style="height:300px; width:400px; border: 1px solid grey; float: left"></div>
      <pre id="results" style="height:300px; width:400px; border: 1px solid grey; float: left"></pre>
    </div>
    <button id="eval" stype="height:50px">Eval</button>


    <script>
      var require = { paths: { vs: './node_modules/monaco-editor/min/vs' } };
    </script>
    <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
    <script src="./node_modules/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
    <script src="./node_modules/monaco-editor/min/vs/editor/editor.main.js"></script>

    <script type="module">
      import init, { Engine } from './pkg/regorus.js';

      function loadFile(filePath) {
	  var result = null;
	  var xmlhttp = new XMLHttpRequest();
	  xmlhttp.open("GET", filePath, false);
	  xmlhttp.send();
	  if (xmlhttp.status==200) {
	      result = xmlhttp.responseText;
	  }
	  return result;
      }
      monaco.languages.register( { id : 'Rego'})

      let rego_language = {
	  //	  defaultToken: 'invalid',

	  keywords: [
	      'as',
	      'contains',
	      'default',
	      'else',
	      'every',
	      'false',
	      'if',
	      'import',
	      'in',
	      'not',
	      'null',
	      'package',
	      'set(',
	      'some',
	      'true',
	      'with',
	  ],

          brackets: [
              ['{','}','delimiter.curly'],
              ['[',']','delimiter.square'],
              ['(',')','delimiter.parenthesis']
          ],

	  operators: [
	      '+', '-', '*', '/', '%',
	      '&', '|',
	      ',', ';', '.',
	      ':',
	      '<', '<=', '=', '==', '>', '>=',
	      '!', '!=',
	  ],

	  // we include these common regular expressions
	  symbols:  /[=><!~?:&|+\-*\/\^%]+/,

	  tokenizer: {
	      root: [
		  [/[a-zA-Z'_\?\\][\w'\?\\]*/, { cases: {'@keywords': 'keyword',
							 '@default' : 'identifier' }}],

		  [':=', 'keyword'],

		  [/"[^\\"]*"/,  'string'],
		  [/`[^\\`]*`/,  'string'],

		  // delimiters and operators
		  [/[{}()\[\]]/, '@brackets'],
		  [/[<>](?!@symbols)/, '@brackets'],


		  [/@symbols/, { cases: { '@operators': 'delimiter',
					  '@default'  : '' } } ],

		  // numbers
		  [/[0-9_]*\.[0-9_]+([eE][\-+]?\d+)?[fFdD]?/, 'number.float'],
		  [/[0-9_]+/, 'number'],

		  // delimiter: after number because of .\d floats
		  [/[;,.]/, 'delimiter'],
		  // whitespace
		  { include: '@whitespace' },

	      ],

	      whitespace: [
		  [/[ \t\r\n]+/, 'white'],
		  [/#.*$/,    'comment'],
	      ],

	  }
      };

      monaco.languages.setMonarchTokensProvider('Rego', rego_language)


      let separator = "\n###POLICY###\n"
      let framework_rego = 'package play'
      var rego_editor = monaco.editor.create(document.getElementById('rego_container'), {
	  value: framework_rego,
	  language: 'Rego'
      });

      var input_editor = monaco.editor.create(document.getElementById('input_container'), {
	  value: '{}',
	  language: 'javascript'
      });

      var results_editor = monaco.editor.create(document.getElementById('results'), {
	  value: '{}',
	  language: 'json',
	  readOnly: true
      })

      rego_editor.setValue(loadFile("./examples/example.rego"))
      input_editor.setValue(loadFile("./examples/input.json"))

      function eval_query() {
	  let policy = rego_editor.getValue();
	  let files = policy.split(separator)

	  var startTime = new Date();
	  var engine = new Engine();
	  for (var i =0; i < files.length; ++i) {
	      engine.add_policy("policy.rego", files[i])
	  }

	  let input = input_editor.getValue();
	  engine.set_input(input);
	  
	  let results = engine.eval_query("data");
	  var elapsed = new Date() - startTime;

	  let output = `// Evaluation took ${elapsed} milliseconds.\n${results}`;
	  results_editor.setValue(output)
	  
      }
      async function run() {
	  await init()


	  document.getElementById('eval').onclick = eval_query;
      }
      run();
    </script>


  </body>
</html>
